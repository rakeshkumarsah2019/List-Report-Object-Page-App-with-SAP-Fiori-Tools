import { config } from 'dotenv';
import { resolve } from 'path';
import { readFileSync } from 'fs';
import { Ui5AbapRepository } from '../../src';

async function run(): Promise<void> {
    config();
    // this folder is hidden by vscode and webstorm
    const configFile = resolve(__dirname, '.hg', 'systems', `${process.argv[2].toLowerCase()}.json`);
    const { target, credentials, app, test } = JSON.parse(readFileSync(configFile, 'utf-8'));
    if (credentials.username) {
        credentials.username = process.env[credentials.username.split(':')[1]];
        credentials.password = process.env[credentials.password.split(':')[1]];
    }
    if (credentials.serviceKeys) {
        credentials.serviceKeys = resolve(__dirname, 'systems', credentials.serviceKeys);
    }
    const client = new Ui5AbapRepository({ system: target, credentials });
    await client.deploy(resolve(__dirname, 'Archive.zip'), app, test);
}
run();
