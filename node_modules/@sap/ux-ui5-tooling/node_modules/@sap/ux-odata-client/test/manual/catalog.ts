import { config } from 'dotenv';
import { resolve } from 'path';
import { readFileSync } from 'fs';
import { Catalog } from '../../src';

async function run(): Promise<void> {
    config();

    // this folder is hidden by vscode and webstorm
    const configFile = resolve(__dirname, '.hg', 'systems', `${process.argv[2].toLowerCase()}.json`);
    const { target: system, credentials, 'test:catalog': testConfig } = JSON.parse(readFileSync(configFile, 'utf-8'));
    if (credentials) {
        if (credentials.username) {
            credentials.username = process.env[credentials.username.split(':')[1]];
            credentials.password = process.env[credentials.password.split(':')[1]];
        }
        if (credentials.serviceKeys) {
            credentials.serviceKeys = resolve(__dirname, 'systems', credentials.serviceKeys);
        }
    }

    const client = new Catalog({ system, credentials });
    const services = await client.listServices();
    console.log(`${services.length} services found!`);
    const filter = { path: testConfig ? testConfig.path : '/sap/opu/odata/sap/SEPMRA_PROD_MAN' };
    const annotations = await client.getAnnotations(filter);
    console.log(
        `${annotations.length} annotation file${annotations.length !== 1 ? 's' : ''} for ${JSON.stringify(
            filter
        )} found!`
    );
    if (annotations && annotations.length > 0) {
        annotations.forEach((anno) => {
            console.log(anno.Uri);
        });
    }
}
run();
